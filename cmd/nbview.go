package main

import (
	"encoding/base64"
	"io/ioutil"
	"log"
	"os"
	"os/exec"
	"path/filepath"
	"runtime"
)

// gzip first?
// also - generate from static files
var html string = "PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9J3V0Zi04JyAvPgogICAgICAgIDx0aXRsZT5uYnZpZXdlci5qczwvdGl0bGU+CgogICAgPGxpbmsgcmVsPSdzdHlsZXNoZWV0JyBocmVmPSdodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9wcmlzbS8xLjUuMS90aGVtZXMvcHJpc20ubWluLmNzcycvPgogICAgPHNjcmlwdCBzcmM9J2h0dHBzOi8vY2RuanMuY2xvdWRmbGFyZS5jb20vYWpheC9saWJzL21hcmtlZC8wLjMuNi9tYXJrZWQubWluLmpzJz48L3NjcmlwdD4gICAgCiAgICA8c2NyaXB0IHNyYz0naHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvcHJpc20vMS41LjEvcHJpc20ubWluLmpzJyBkYXRhLW1hbnVhbD48L3NjcmlwdD4KICAgIDxzY3JpcHQgc3JjPSdodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9wcmlzbS8xLjUuMS9jb21wb25lbnRzL3ByaXNtLXB5dGhvbi5taW4uanMnIGRhdGEtbWFudWFsPjwvc2NyaXB0PgoKICAgIDxzdHlsZSB0eXBlPSd0ZXh0L2Nzcyc+CiAgICAgICAgYm9keSB7CiAgICAgICAgICAgIGZvbnQ6IDAuOGVtIEFyaWFsLCBzYW5zLXNlcmlmOwogICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZWVlOwogICAgICAgIH0KICAgIDwvc3R5bGU+CgogICAgPCEtLSBuYnZpZXdlci5qcyAtLT4KICAgIDxsaW5rIHJlbD0nc3R5bGVzaGVldCcgaHJlZj0nbmJ2LmNzcycvPgogICAgPHNjcmlwdCBzcmM9J25idi5qcyc+PC9zY3JpcHQ+CiAgICA8c2NyaXB0IHNyYz0nbm90ZWJvb2suanMnPjwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgoKPGRpdiBpZD0nZG9jJz4KCjwvZGl2PgoKCjxzY3JpcHQgdHlwZT0ndGV4dC9qYXZhc2NyaXB0Jz4KICAgIHZhciBkID0gZG9jdW1lbnQKICAgIHZhciBkb2MgPSBkLmdldEVsZW1lbnRCeUlkKCdkb2MnKQogICAgbmJ2LnJlbmRlcihuYiwgZG9jKQo8L3NjcmlwdD4KCjwvYm9keT4KPC9odG1sPgoK"
var css string = "ZGl2Lm5iZG9jdW1lbnQgewogICAgbWF4LXdpZHRoOiA5NjBweDsKICAgIGJvcmRlcjogMXB4IHNvbGlkwqAjY2NjOwogICAgbWFyZ2luOiAxZW0gYXV0bzsKICAgIHBhZGRpbmc6IDEuNWVtIDEuNWVtIDEuNWVtIDdlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgLypib3JkZXItcmFkaXVzOiAxMHB4OyovCiAgICBib3gtc2hhZG93OiAwIDAgMTBweCAjY2NjOwp9CmRpdi5uYmRvY3VtZW50IGRpdi5jZWxsIHsKICAgIHBhZGRpbmctYm90dG9tOiAuNWVtOwogICAgLypwYWRkaW5nLXRvcDogLjFlbTsqLwp9CmRpdi5uYmRvY3VtZW50IGRpdiB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7IC8qIGZvciBleGNvdW50cyAqLwp9CmRpdi5uYmRvY3VtZW50IGRpdi5jZWxsIHNwYW4uZXhjb3VudCB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNXB4OyBsZWZ0OiAtNy41ZW07CiAgICB3aWR0aDogN2VtOwogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIHRleHQtYWxpZ246IHJpZ2h0Owp9CmRpdi5uYmRvY3VtZW50IHNwYW4uZXhjb3VudC1pbiB7CiAgICBjb2xvcjogIzMwM2ZiYTsKfQpkaXYubmJkb2N1bWVudCBzcGFuLmV4Y291bnQtb3V0IHsKICAgIGNvbG9yOiAjZGU0ODE1OwogICAgdG9wOiAwICFpbXBvcnRhbnQ7Cn0KZGl2Lm5iZG9jdW1lbnQgZGl2LmNlbGwgcHJlLmNvZGUtY2VsbCB7CiAgICBiYWNrZ3JvdW5kOiAjZjdmN2Y3OwogICAgYm9yZGVyOiAxcHggc29saWQgI2NmY2ZjZjsKICAgIHBhZGRpbmc6IC40ZW07CiAgICBtYXJnaW4tYm90dG9tOiAwOwogICAgbWFyZ2luLXRvcDogMDsKICAgIGJvcmRlci1yYWRpdXM6IDJweDsKICAgIG92ZXJmbG93LXg6IHNjcm9sbDsKICAgIG1pbi1oZWlnaHQ6IC44NWVtOwp9CmRpdi5uYmRvY3VtZW50IGRpdi5jZWxsLW91dHB1dCB7CiAgICBtaW4taGVpZ2h0OiAxZW07Cn0KZGl2Lm5iZG9jdW1lbnQgZGl2LnBsYWluLWh0bWwgewogICAgb3ZlcmZsb3c6IHNjcm9sbDsKfQoKZGl2Lm5iZG9jdW1lbnQgdGFibGUuZGF0YWZyYW1lIHsKICAgIGJvcmRlci1jb2xsYXBzZTogY29sbGFwc2U7CiAgICB0ZXh0LWFsaWduOiBsZWZ0Owp9CmRpdi5uYmRvY3VtZW50IHRhYmxlLmRhdGFmcmFtZSB0aCwgZGl2Lm5iZG9jdW1lbnQgdGFibGUuZGF0YWZyYW1lIHRkIHsKICAgIHBhZGRpbmc6IDNweDsKfQ=="
var js string = "dmFyIG5idiA9IChmdW5jdGlvbigpIHsKICAgICd1c2Ugc3RyaWN0JwoKICAgIHZhciBkID0gZG9jdW1lbnQKICAgIHZhciBzdCA9IHt9IC8vIHNldHRpbmdzCgogICAgZnVuY3Rpb24gcmVuZGVyX2lweW5iKG9iaiwgdGFyZ2V0LCBzZXR0aW5ncykgewogICAgICAgIGlmICghd2luZG93Lm1hcmtlZCB8fCAhd2luZG93LlByaXNtKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2V4cGVjdGluZyBsaWJyYXJpZXMgbWFya2VkLmpzIGFuZCBQcmlzbS5qcyB0byBiZSBwcmVzZW50JykKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIHN0ID0gc2V0dGluZ3MgfHwge30KCiAgICAgICAgc3QubmJmb3JtYXQgPSBvYmoubmJmb3JtYXQKICAgICAgICBpZiAoc3QubmJmb3JtYXQgPCAzKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Zvcm1hdCBvZiB0aGUgbm90ZWJvb2sgdG9vIG9sZCcpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIH0KCiAgICAgICAgaWYgKHN0Lm5iZm9ybWF0ID4gMykKICAgICAgICAgICAgc3QubGFuZyA9IG9iai5tZXRhZGF0YS5rZXJuZWxzcGVjLmxhbmd1YWdlCiAgICAgICAgCiAgICAgICAgLy8gd2lwZSBhbGwgaW5uZXIgZWxlbWVudHMgb2Ygb3VyIHRhcmdldAogICAgICAgIHdoaWxlICh0YXJnZXQuZmlyc3RDaGlsZCkgewogICAgICAgICAgICB0YXJnZXQucmVtb3ZlQ2hpbGQodGFyZ2V0LmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgICB2YXIgdCA9IGQuY3JlYXRlRWxlbWVudCgnZGl2JykKICAgICAgICB0LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnbmJkb2N1bWVudCcpCiAgICAgICAgdGFyZ2V0LmFwcGVuZENoaWxkKHQpCiAgICAgICAgc3QudGFyZ2V0ID0gdAoKICAgICAgICAvLyB2NCBoYXMgY2VsbHMgZGlyZWN0bHkgaW4gdGhlIG9iamVjdCwgdjMgaGFkIGEgbGlzdCBvZgogICAgICAgIC8vIHdvcmtzaGVldHMsIGVhY2ggd2l0aCBhIGxpc3Qgb2YgY2VsbHMKICAgICAgICB2YXIgY2VsbHMgPSBvYmouY2VsbHMgfHwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciByZXQgPSBbXQogICAgICAgICAgICBmb3IgKHZhciBqPTA7IGogPCBvYmoud29ya3NoZWV0cy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgcmV0ID0gcmV0LmNvbmNhdChvYmoud29ya3NoZWV0c1tqXS5jZWxscykKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV0CiAgICAgICAgfSgpCgogICAgICAgIGZvciAodmFyIGo9MDsgaiA8IGNlbGxzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHZhciB0YyA9IGNlbGxzW2pdCgogICAgICAgICAgICB2YXIgY2VsbCA9IGQuY3JlYXRlRWxlbWVudCgnZGl2JykKICAgICAgICAgICAgY2VsbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2NlbGwnKQoKICAgICAgICAgICAgdmFyIGRtID0gZC5jcmVhdGVFbGVtZW50KCdkaXYnKSAvLyBlbXB0eSBkaXYgYXMgYSBmYWxsYmFjawoKICAgICAgICAgICAgc3dpdGNoICh0Yy5jZWxsX3R5cGUpIHsKICAgICAgICAgICAgICAgIGNhc2UgJ2NvZGUnOgogICAgICAgICAgICAgICAgICAgIGRtID0gaGFuZGxlX2NvZGUodGMpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGNhc2UgJ21hcmtkb3duJzoKICAgICAgICAgICAgICAgICAgICBkbSA9IGhhbmRsZV9tZG93bih0YykKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignVW5zdXBwb3J0ZWQgY2VsbCB0eXBlOiAnICsgdGMuY2VsbF90eXBlKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNlbGwuYXBwZW5kQ2hpbGQoZG0pCiAgICAgICAgICAgIHQuYXBwZW5kQ2hpbGQoY2VsbCkKICAgICAgICB9CgogICAgICAgIGlmIChzdC50b2MpCiAgICAgICAgICAgIHJlbmRlcl90b2MoKQogICAgfQoKICAgIGZ1bmN0aW9uIGV4Y291bnQoY2VsbCwgdGluKSB7CiAgICAgICAgdmFyIHRpbiA9IHRpbiB8fCB0cnVlIC8vICdJbiBbXScgb3IgJ091dCBbXScKICAgICAgICB2YXIgY2MgPSBkLmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKQogICAgICAgIGNjLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnZXhjb3VudCBleGNvdW50LScgKyAodGluID8gJ2luJyA6ICdvdXQnKSkKICAgICAgICBjYy50ZXh0Q29udGVudCA9ICh0aW4gPyAnSW4nOiAnT3V0JykgKyAnIFsnICsKICAgICAgICAgICAgKCghY2VsbC5leGVjdXRpb25fY291bnQgJiYgIWNlbGwucHJvbXB0X251bWJlcikgPyAnICcgOgogICAgICAgICAgICAgICAgKGNlbGwuZXhlY3V0aW9uX2NvdW50IHx8IGNlbGwucHJvbXB0X251bWJlcikpICsgJ106JwogICAgICAgIHJldHVybiBjYwogICAgfQoKICAgIC8vIHJlY2VpdmVzIGNlbGwsIG91dHB1dHMgRE9NCiAgICBmdW5jdGlvbiBoYW5kbGVfY29kZShjZWxsKSB7CiAgICAgICAgdmFyIGVsID0gZC5jcmVhdGVFbGVtZW50KCdkaXYnKSAvLyBjb250YWluZXIgZm9yIGl0IGFsbAoKCiAgICAgICAgZWwuYXBwZW5kQ2hpbGQoZXhjb3VudChjZWxsLCB0cnVlKSkKCiAgICAgICAgdmFyIHByZSA9IGQuY3JlYXRlRWxlbWVudCgncHJlJykKICAgICAgICAvLyBiZWNhdXNlIGNvZGUgbWF5IGFsc28gYmUgd2l0aGluIG1hcmtkb3duOgogICAgICAgIHByZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2NvZGUtY2VsbCcpCiAgICAgICAgdmFyIGNvZGUgPSBkLmNyZWF0ZUVsZW1lbnQoJ2NvZGUnKQoKICAgICAgICAvLyBpZiAoc3QuaGFzT3duUHJvcGVydHkoJ2xhbmcnKSkKICAgICAgICBjb2RlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnbGFuZ3VhZ2UtJyArIHN0LmxhbmcgfHwgY2VsbC5sYW5ndWFnZSkKCiAgICAgICAgLy8gbm8gbmVlZCB0byBqb2luIG9uICdcbicgLSBuZXdsaW5lcyBhcmUgaW4gdGhlIGNvZGUgYWxyZWFkeQogICAgICAgIC8vIC5zb3VyY2UgZm9yIHY0LCAuaW5wdXQgZm9yIHYzCiAgICAgICAgY29kZS50ZXh0Q29udGVudCA9IChjZWxsLnNvdXJjZSB8fCBjZWxsLmlucHV0KS5qb2luKCcnKQoKICAgICAgICBwcmUuYXBwZW5kQ2hpbGQoY29kZSkKICAgICAgICBlbC5hcHBlbmRDaGlsZChwcmUpCiAgICAgICAgUHJpc20uaGlnaGxpZ2h0RWxlbWVudChjb2RlKQoKICAgICAgICAvLyBvdXRwdXRzIG5vdwogICAgICAgIHZhciBvdXRwID0gZC5jcmVhdGVFbGVtZW50KCdkaXYnKQogICAgICAgIG91dHAuc2V0QXR0cmlidXRlKCdjbGFzcycsICdvdXRwdXRzJykKCiAgICAgICAgZm9yICh2YXIgaj0wOyBqIDwgY2VsbC5vdXRwdXRzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHZhciBkbSA9IGQuY3JlYXRlRWxlbWVudCgnZGl2JykgLy8gd3JhcHBlcgogICAgICAgICAgICB2YXIgZHQgPSBjZWxsLm91dHB1dHNbal0KICAgICAgICAgICAgaWYgKGR0Lm91dHB1dF90eXBlID09ICdleGVjdXRlX3Jlc3VsdCcpCiAgICAgICAgICAgICAgICBkbS5hcHBlbmRDaGlsZChleGNvdW50KGR0LCBmYWxzZSkpCgogICAgICAgICAgICBzd2l0Y2ggKGR0Lm91dHB1dF90eXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlICdleGVjdXRlX3Jlc3VsdCc6CiAgICAgICAgICAgICAgICAgICAgZG0uYXBwZW5kQ2hpbGQoaGFuZGxlX2NlbGxfb3V0cHV0KGR0KSkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY2FzZSAnc3RyZWFtJzoKICAgICAgICAgICAgICAgICAgICBkbS5hcHBlbmRDaGlsZChoYW5kbGVfc3RyZWFtX291dHB1dChkdCkpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGNhc2UgJ2Rpc3BsYXlfZGF0YSc6CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0Lm5iZm9ybWF0ID4gMykgewogICAgICAgICAgICAgICAgICAgICAgICBkbS5hcHBlbmRDaGlsZChoYW5kbGVfY2VsbF9vdXRwdXQoZHQpKQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBpZiAzLCBmYWxsIHRocm91Z2ggdG8gcHlvdXQKICAgICAgICAgICAgICAgIGNhc2UgJ3B5b3V0JzoKICAgICAgICAgICAgICAgICAgICAvLyBsZWdhY3kgKHYzKQogICAgICAgICAgICAgICAgICAgIGRtLmFwcGVuZENoaWxkKGhhbmRsZV9weW91dChkdCkpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ05vdCBzdXBwb3J0ZWQgb3V0cHV0X3R5cGU6ICcgKwogICAgICAgICAgICAgICAgICAgICAgICBjZWxsLm91dHB1dHNbal0ub3V0cHV0X3R5cGUpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG91dHAuYXBwZW5kQ2hpbGQoZG0pCiAgICAgICAgfQogICAgICAgIGVsLmFwcGVuZENoaWxkKG91dHApCgogICAgICAgIHJldHVybiBlbAogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZV9jZWxsX291dHB1dChkdCkgewogICAgICAgIHZhciBlbCA9IGQuY3JlYXRlRWxlbWVudCgnZGl2JykKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2NlbGwtb3V0cHV0JykKICAgICAgICBlbC5zdHlsZS5jbGVhciA9ICdib3RoJwoKCiAgICAgICAgLy8gaW5kaXZpZHVhbCBvdXRwdXRzCiAgICAgICAgdmFyIGZtdHMgPSBPYmplY3Qua2V5cyhkdC5kYXRhKQogICAgICAgIGZvciAodmFyIGo9MDsgaiA8IGZtdHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgdmFyIGZtdCA9IGZtdHNbal0KICAgICAgICAgICAgdmFyIGRtID0gZC5jcmVhdGVFbGVtZW50KCdkaXYnKQogICAgICAgICAgICBzd2l0Y2ggKGZtdCkgewogICAgICAgICAgICAgICAgY2FzZSAndGV4dC9wbGFpbic6CiAgICAgICAgICAgICAgICAgICAgZG0gPSBkLmNyZWF0ZUVsZW1lbnQoJ3ByZScpCiAgICAgICAgICAgICAgICAgICAgZG0udGV4dENvbnRlbnQgPSBkdC5kYXRhW2ZtdF0uam9pbignJykKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQvaHRtbCc6CiAgICAgICAgICAgICAgICAgICAgZG0uc2V0QXR0cmlidXRlKCdjbGFzcycsICdwbGFpbi1odG1sJykKICAgICAgICAgICAgICAgICAgICBkbS5pbm5lckhUTUwgPSBkdC5kYXRhW2ZtdF0uam9pbignJykKICAgICAgICAgICAgICAgICAgICBicmVhawoKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgaWYgKGZtdC5zdGFydHNXaXRoKCdpbWFnZS8nKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkbSA9IGQuY3JlYXRlRWxlbWVudCgnaW1nJykKICAgICAgICAgICAgICAgICAgICAgICAgZG0uc2V0QXR0cmlidXRlKCdzcmMnLCAnZGF0YTonIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBmbXQgKyAnO2Jhc2U2NCwnICsgZHQuZGF0YVtmbXRdKQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCd1bmV4cGVjdGVkIGZvcm1hdDogJyArIGZtdCkKICAgICAgICAgICAgfQogICAgICAgICAgICBlbC5hcHBlbmRDaGlsZChkbSkKCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZWwKICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVfc3RyZWFtX291dHB1dChkdCkgewogICAgICAgIC8vIG5hbWUgaW4gdjQsIHN0cmVhbSBpbiB2MwogICAgICAgIGlmICggKGR0Lm5hbWUgfHwgZHQuc3RyZWFtKSAhPSAnc3Rkb3V0JyB8fCBkdC5vdXRwdXRfdHlwZSAhPSAnc3RyZWFtJykKICAgICAgICAgICAgY29uc29sZS5lcnJvcigndW5leHBlY3RlZCBzdHJlYW0gc3BlYycpCgogICAgICAgIGlmICghZHQuaGFzT3duUHJvcGVydHkoJ3RleHQnKSkKICAgICAgICAgICAgY29uc29sZS5lcnJvcignZGF0YSBmb3Igc3RyZWFtIG1pc3NpbmcnKQoKICAgICAgICB2YXIgY24gPSBkLmNyZWF0ZUVsZW1lbnQoJ3ByZScpCiAgICAgICAgY24udGV4dENvbnRlbnQgPSBkdC50ZXh0LmpvaW4oJycpCgogICAgICAgIHJldHVybiBjbgogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZV9tZG93bihjZWxsKSB7CiAgICAgICAgdmFyIGVsID0gZC5jcmVhdGVFbGVtZW50KCdkaXYnKQogICAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnbWFya2Rvd24nKQogICAgICAgIGVsLmlubmVySFRNTCA9IG1hcmtlZChjZWxsLnNvdXJjZS5qb2luKCcnKSkKCiAgICAgICAgcmV0dXJuIGVsCiAgICB9CgogICAgLy8gaGFuZGxpbmcgbGVnYWN5IG5vdGVib29rcyAodjMpCiAgICBmdW5jdGlvbiBoYW5kbGVfcHlvdXQoY2VsbCkgewogICAgICAgIHZhciBlbCA9IGQuY3JlYXRlRWxlbWVudCgnZGl2JykKCiAgICAgICAgaWYgKGNlbGwuaGFzT3duUHJvcGVydHkoJ3Byb21wdF9udW1iZXInKSkKICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQoZXhjb3VudChjZWxsLCBmYWxzZSkpCgogICAgICAgIC8vIHZhciBrcyA9IE9iamVjdC5rZXlzKGNlbGwpCiAgICAgICAgLy8gdGV4dCwgcG5nLCBqcGVnLCBodG1sIC0tIHN1cHBvcnRlZAogICAgICAgIC8vIHN2ZywgbGF0ZXgsIGphdmFzY3JpcHQsIGpzb24sIHBkZiwgbWV0YWRhdGEgLS0gbm90IHlldAogICAgICAgIE9iamVjdC5rZXlzKGNlbGwpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICAgICAgICBpZiAoWydvdXRwdXRfdHlwZScsICdwcm9tcHRfbnVtYmVyJ10uaW5kZXhPZihrKSA+IC0xKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHZhciBwID0gZC5jcmVhdGVFbGVtZW50KCdzcGFuJykgLy8gaWYgZXJycwogICAgICAgICAgICBzd2l0Y2ggKGspIHsKICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQnOgogICAgICAgICAgICAgICAgICAgIHAgPSBkLmNyZWF0ZUVsZW1lbnQoJ3ByZScpCiAgICAgICAgICAgICAgICAgICAgcC50ZXh0Q29udGVudCA9IGNlbGxba10uam9pbignJykKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY2FzZSAnaHRtbCc6CiAgICAgICAgICAgICAgICAgICAgcCA9IGQuY3JlYXRlRWxlbWVudCgnZGl2JykKICAgICAgICAgICAgICAgICAgICAvLyBndWVzc2luZyBoZXJlLCBoYXZlbid0IHNlZW4gYSB2MyBIVE1MIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBwLmlubmVySFRNTCA9IGNlbGxba10uam9pbignJykKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY2FzZSAncG5nJzoKICAgICAgICAgICAgICAgIGNhc2UgJ2pwZWcnOgogICAgICAgICAgICAgICAgICAgIHAgPSBkLmNyZWF0ZUVsZW1lbnQoJ2ltZycpCiAgICAgICAgICAgICAgICAgICAgcC5zZXRBdHRyaWJ1dGUoJ3NyYycsICdkYXRhOicgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGsgKyAnO2Jhc2U2NCwnICsgY2VsbFtrXSkKCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCgogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCd1bnN1cHBvcnRlZCBweW91dCBmb3JtYXQ6ICcgKyBrKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKHApCiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBlbAogICAgfQoKICAgIGZ1bmN0aW9uIHNhbml0aXNlKGVsKSB7CiAgICAgICAgcmV0dXJuIGVsLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXFcrL2csICctJykKICAgIH0KCiAgICBmdW5jdGlvbiByZW5kZXJfdG9jKCkgewogICAgICAgIHZhciBlbHMgPSBzdC50YXJnZXQucXVlcnlTZWxlY3RvcignaDEsaDIsaDMsaDQsaDUsaDYnKQogICAgICAgIC8vIGlmIG5vIGhlYWRpbmdzIGZvdW5kLCBvdXIgam9iIGlzIGRvbmUKICAgICAgICBpZiAoZWxzLmxlbmd0aCA9PSAwKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAvLyBmaW5kIHRoZSBtaW5pbXVtIGxldmVsIG9mIGEgaGVhZGluZwogICAgICAgIHZhciBtaW5sID0gNgogICAgICAgIGZvciAodmFyIGo9MDsgajxlbHMubGVuZ3RoO2orKykgewogICAgICAgICAgICBtaW5sID0gKGVsc1tqXS5ub2RlTmFtZVsxXSA8IG1pbmwpID8gCiAgICAgICAgICAgICAgICBwYXJzZUludChlbHNbal0ubm9kZU5hbWVbMV0pIDogbWlubAogICAgICAgIH0KICAgICAgICAKICAgICAgICAKCiAgICB9CiAgICAvLyBiYXNlZCBvbiBhIGxpc3Qgb2YgaGVhZGluZ3MgKyB0aGUgY3VycmVudCBsZXZlbCwKICAgIC8vIGVpdGhlciByZW5kZXIgbW9yZSBvciByZWN1cnNpdmVseSBnZW5lcmF0ZSBuZXN0ZWQgaGVhZGluZ3MKICAgIGZ1bmN0aW9uIGxpc3RfaHMob2JqLCBjbGV2KSB7CiAgICAgICAgdmFyIHVsID0gZC5jcmVhdGVFbGVtZW50KCd1bCcpCgoKICAgIH0KCgogICAgcmV0dXJuIHsKICAgICAgICByZW5kZXI6IHJlbmRlcl9pcHluYgogICAgfQoKfSkoKTsK"

func main() {
	if len(os.Args) != 2 {
		log.Fatal("Not supplied a filename")
	}

	// read input notebook
	fn := os.Args[1]
	cn, err := ioutil.ReadFile(fn)
	if err != nil {
		log.Fatal(err)
	}

	tdir, er := ioutil.TempDir("", "nb_")
	// tmp, er := ioutil.TempFile("", "nb_")
	if er != nil {
		log.Fatal(er)
	}

	htmlstr, _ := base64.StdEncoding.DecodeString(html)
	if err := ioutil.WriteFile(filepath.Join(tdir, "index.html"), []byte(htmlstr), 0666); err != nil {
		log.Fatal(err)
	}
	cssstr, _ := base64.StdEncoding.DecodeString(css)
	if err := ioutil.WriteFile(filepath.Join(tdir, "nbv.css"), []byte(cssstr), 0666); err != nil {
		log.Fatal(err)
	}
	jsstr, _ := base64.StdEncoding.DecodeString(js)
	if err := ioutil.WriteFile(filepath.Join(tdir, "nbv.js"), []byte(jsstr), 0666); err != nil {
		log.Fatal(err)
	}
	if err := ioutil.WriteFile(filepath.Join(tdir, "notebook.js"), append([]byte("var nb = "), cn...), 0666); err != nil {
		log.Fatal(err)
	}

	// launch browser
	tfn := filepath.Join(tdir, "index.html")

	var eerr error
	switch runtime.GOOS {
	case "windows":
		eerr = exec.Command("cmd", "/c", "start", tfn).Start()
	case "darwin":
		eerr = exec.Command("open", tfn).Start()
	case "linux", "freebsd", "netbsd", "openbsd":
		eerr = exec.Command("xdg-open", tfn).Start()
	default:
		log.Fatalf("%s not supported", runtime.GOOS)
	}
	if eerr != nil {
		log.Fatal(eerr)
	}

}
